# Домашнее задание к занятию  «Базы данных, их типы» - Спетницкий Д.И.

## Задание 1 СУБД
Кейс

Крупная строительная компания, которая также занимается проектированием и девелопментом, решила создать правильную архитектуру для работы с данными. Ниже представлены задачи, которые необходимо решить для каждой предметной области.

Какие типы СУБД, на ваш взгляд, лучше всего подойдут для решения этих задач и почему?

- 1.1. Бюджетирование проектов с дальнейшим формированием финансовых аналитических отчётов и прогнозирования рисков. СУБД должна гарантировать целостность и чёткую структуру данных.

- 1.1.* Хеширование стало занимать длительно время, какое API можно использовать для ускорения работы?

- 1.2. Под каждый девелоперский проект создаётся отдельный лендинг, и все данные по лидам стекаются в CRM к маркетологам и менеджерам по продажам. Какой тип СУБД лучше использовать для лендингов и для CRM? СУБД должны быть гибкими и быстрыми.

- 1.2.* Можно ли эту задачу закрыть одной СУБД? И если да, то какой именно СУБД и какой реализацией?

- 1.3. Отдел контроля качества решил создать базу по корпоративным нормам и правилам, обучающему материалу и так далее, сформированную согласно структуре компании. СУБД должна иметь простую и понятную структуру.

- 1.3.* Можно ли под эту задачу использовать уже существующую СУБД из задач выше и если да, то как лучше это реализовать?

- 1.4. Департамент логистики нуждается в решении задач по быстрому формированию маршрутов доставки материалов по объектам и распределению курьеров по маршрутам с доставкой документов. СУБД должна уметь быстро работать со связями.

- 1.4.* Можно ли к этой СУБД подключить отдел закупок или для них лучше сформировать свою СУБД в связке с СУБД логистов?

- 1.5.* Можно ли все перечисленные выше задачи решить, используя одну СУБД? Если да, то какую именно?

Приведите ответ в свободной форме.

---

## Решение 1

### 1.1. Бюджетирование проектов и аналитика
Тип СУБД: Реляционная

- Гарантия целостности данных через ACID-транзакции, внешние ключи и строгую схему.
- Поддержка сложных SQL-запросов для аналитических отчетов и прогнозирования.
- Возможность использования OLAP-инструментов.

### 1.1.* Ускорение хеширования

Redis или Memcached для кэширования часто используемых хешей.

### 1.2. Лендинги и CRM
Тип СУБД:

- Для лендингов: Документоориентированная (MongoDB, Firestore) — гибкость схемы для разных форм лидов.
- Для CRM: Гибридная (PostgreSQL с JSONB) или документоориентированная (MongoDB) — баланс между структурированными (клиенты, сделки) и неструктурированными (комментарии, история) данными.
### 1.2.* Одна СУБД для обеих задач
Да. PostgreSQL с:

- Реляционными таблицами для CRM (сделки, клиенты).
- JSONB-полями для хранения данных с лендингов.
- Расширением pg_partman для партиционирования данных лидов.

Альтернатива: MongoDB с транзакциями (версия 4.0+).

### 1.3. База знаний отдела контроля качества
Тип СУБД: Документоориентированная (MongoDB, CouchDB) или реляционная (SQLite для небольших объемов).

Простота создания иерархических структур (разделы → подразделы → документы).

Легкое обновление контента без миграций схемы.
### 1.3.* Использование существующей СУБД
Да. Если в задаче 1.2 выбран PostgreSQL, можно:

- Создать таблицу с JSONB-полем для хранения обучающих материалов.
- Использовать полнотекстовый поиск (tsvector) для быстрого поиска по документам.
- Если используется MongoDB — отдельная коллекция с тегами и версиями материалов.

### 1.4. Логистика
Тип СУБД: Графовая.

Эффективная работа со связями (точки доставки, дорожная сеть, загрузка курьеров).
Встроенные алгоритмы (кратчайший путь, кластеризация).

### 1.4.* Интеграция с отделом закупок
Нет. Для закупок лучше использовать реляционную СУБД (PostgreSQL):

- Закупки требуют ACID-гарантий (договоры, платежи).
- Логистика и закупки интегрируются через API или ETL-процессы.

### 1.5.* Одна СУБД для всех задач
Теоретически да — PostgreSQL.

- Бюджетирование: Реляционные таблицы + OLAP-функции.
- Лендинги/CRM: JSONB-поля + индексы для гибких запросов.
- База знаний: JSONB-коллекции + полнотекстовый поиск.
- Логистика: Расширение PostGIS для геоданных и алгоритмов маршрутизации.

Недостатки:

- Снижение производительности для графовых операций.
- Сложность администрирования мультимодельной архитектуры.

---

## Задание 2 Транзакции

- 2.1. Пользователь пополняет баланс счёта телефона, распишите пошагово, какие действия должны произойти для того, чтобы транзакция завершилась успешно. Ориентируйтесь на шесть действий.

- 2.1.* Какие действия должны произойти, если пополнение счёта телефона происходило бы через автоплатёж?

Приведите ответ в свободной форме.

---

## Решение 2

### 2.1. Пошаговые действия для успешного пополнения баланса

1. Проверка валидности запроса: Система проверяет корректность номера телефона и сумму пополнения (например, отсутствие отрицательных значений).
2. Авторизация платежа: Пользователь вводит данные карты, система проверяет наличие средств и лимиты на карте через платежный шлюз.
3. Блокировка баланса: Для обеспечения изолированности (ACID) в СУБД временно блокируется запись о балансе пользователя (например, через SELECT FOR UPDATE в PostgreSQL), чтобы избежать конфликтов при одновременных транзакциях.
4. Списание и зачисление:
- С карты списывается сумма.
- Счет телефона увеличивается на эту же сумму.
5. Фиксация транзакции: СУБД применяет изменения (COMMIT), гарантируя атомарность — либо оба шага (списание и зачисление) завершатся успешно, либо откатятся (ROLLBACK).
6. Уведомление и логирование: Пользователь получает SMS/email о зачислении, система записывает детали операции в логи для аналитики и аудита.

### 2.1.* Особенности автоплатежа

1. Проверка разрешения: Система убеждается, что пользователь ранее разрешил автоплатежи (данные сохранены в зашифрованном виде у платежного шлюза).
2. Автоматическая авторизация: Платежный шлюз списывает средства без участия пользователя, используя токены.
3. Дополнительные проверки: Перед списанием проверяется лимит автоплатежа и актуальность карты (не заблокирована ли).
4. Обработка ошибок: При неудаче (недостаточно средств) система пытается повторить попытку и отправляет уведомление пользователю.
5. Обновление статуса подписки: Если автоплатеж связан с подпиской (например, ежемесячный платеж), обновляется дата следующего списания.
6. Безопасное логирование: Данные карты не сохраняются в БД компании — в логах фиксируются только метаданные (сумма, время, токен платежа).
---

## Задание 3 SQL vs NoSQL

- 3.1. Напишите пять преимуществ SQL-систем по отношению к NoSQL.

- 3.1.* Какие, на ваш взгляд, преимущества у NewSQL систем перед SQL и NoSQL.

Приведите ответ в свободной форме.

---

## Решение 3

### 3.1. Пять преимуществ SQL перед NoSQL

1. ACID-транзакции «из коробки»
SQL-системы гарантируют целостность данных даже при сбоях (например, перевод денег: если что-то пошло не так — всё откатится). В NoSQL такие гарантии часто нужно реализовывать вручную, что увеличивает риск ошибок.

2. JOIN-запросы для связанных данных
В реляционных БД легко объединять данные из нескольких таблиц (например, заказы + клиенты + товары). В NoSQL приходится дублировать данные или делать несколько запросов, что замедляет аналитику.

3. Строгая схема = меньше хаоса
Заранее заданная структура защищает от «мусора» в данных (например, в поле «возраст» не запишется строка). Это упрощает поддержку и снижает баги.

4. Зрелые инструменты и сообщество
SQL существует с 1970-х — есть куча готовых решений, документации и мануалов. NoSQL-стеки (типа Cassandra) моложе, и для них сложнее найти готовые паттерны.

5. Оптимизация под сложные аналитические запросы
Оконные функции, CTE, материализованные представления — всё это «родное» для SQL. В NoSQL для аналитики часто требуются внешние инструменты, что усложняет архитектуру.

### 3.1.* Преимущества NewSQL перед SQL и NoSQL
NewSQL (CockroachDB, Google Spanner, TiDB) — это как «золотая середина».

- Масштабируемость NoSQL + надёжность SQL. Горизонтальное масштабирование (как в MongoDB) при сохранении ACID-транзакций (как в PostgreSQL). Идеально для высоконагруженных сервисов вроде банков.
- SQL-синтаксис без боли. Не нужно переучиваться на новый язык запросов (как в Cassandra с CQL). При этом нет «камней» классического SQL — например, блокировок при шардинге.
- Автоматическая репликация и failover. Системы вроде Spanner сами распределяют данные по регионам и переключаются на резервы при падении нод. В классическом SQL это требует костылей вроде Patroni + etcd.
- Поддержка гибридных нагрузок. Можно одновременно обрабатывать транзакции (OLTP) и строить отчёты (OLAP) без ETL-конвейеров. Например, TiDB разделяет вычисления и хранение, чтобы аналитика не тормозила операционные запросы.
- Облако-нэйтив из коробки. NewSQL-базы проектируются под Kubernetes и serverless-архитектуры. Например, CockroachDB сам управляет шардами при добавлении нод, тогда как в PostgreSQL для этого нужны внешние скрипты.

---

## Задание 4 Кластеры

Необходимо производить большое количество вычислений при работе с огромным количеством данных, под эту задачу выделено 1000 машин.

На основе какого критерия будете выбирать тип СУБД и какая модель распределённых вычислений здесь справится лучше всего и почему?

Приведите ответ в свободной форме.

---

## Решение 4

Главное — смотреть на масштабируемость и скорость обработки данных. Если данных очень много (типа логов, сенсоров, кликов на сайте), то реляционные базы вроде MySQL или PostgreSQL не потянут — они плохо распределяются на тысячи серверов. Поэтому берут NoSQL-системы, например:

- Cassandra или ScyllaDB — они созданы для работы на кластерах из сотен/тысяч машин, автоматически раскидывают данные по нодам и не падают, если часть серверов сдохла.
- ClickHouse — если нужны быстрые отчеты и аналитика (типа «посчитать всех пользователей за последний час»). Он хранит данные колонками, а не строками, поэтому жрет меньше памяти и ресурсов.

Модель вычислений: Apache Spark

- Работает в оперативной памяти — не тратит время на запись промежуточных данных на диск.
- Параллельные вычисления — разбивает задачу на мелкие куски и каждая из 1000 машин обрабатывает свой кусок одновременно.
- Поддерживает всё — можно писать на Python, делать SQL-запросы, машинное обучение.
- Дружит с NoSQL — легко забирает данные из Cassandra или HDFS.

Netflix обрабатывает петабайты данных на Cassandra + Spark. Яндекс тоже использует похожие связки для аналитики.

---