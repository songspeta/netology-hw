# Домашнее задание к занятию  «Резервное копирование баз данных» - Спетницкий Д.И.




## Задание 1. Резервное копирование


### Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования.

Необходимо описать, какие варианты резервного копирования подходят в случаях:

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

*Приведите ответ в свободной форме.*

---


## Решение 1

#### 1.1. Восстановление данных в полном объёме за предыдущий день

 Для этого случая лучше всего подходит **полное резервное копирование (Full Backup)**. Суть в том, что раз в сутки создается полная копия всех данных. Если сегодня случится авария, администратор просто берет вчерашний файл бэкапа и разворачивает его. Это самый простой и надежный способ, но минус в том, что все данные, которые были внесены сегодня до поломки, будут потеряны.

#### 1.2. Восстановление данных за час до предполагаемой поломки

Здесь нужен подход с Point-in-Time Recovery (PITR) — восстановление на момент времени.

Для PostgreSQL:

Используется комбинация физического бэкапа + WAL-журналы (Write-Ahead Log). В журнал записываются все изменения в файлах данных. При восстановлении можно применить базовую копию, а затем «воспроизвести» WAL-журналы до нужного момента (за час до сбоя).

Для MySQL:

Аналогично используются бинарные логи (binary logs) вместе с физическим или логическим бэкапом.
Это обеспечивает минимальный RPO (допустимую потерю данных) — можно восстановиться практически на любой момент времени.


#### 1.3.* Моментальное переключение на работающую базу

Кроме главного сервера (Master) постоянно работают ведомые сервера (Slave). Они получают изменения с мастера в режиме реального времени. Время отката уменьшается почти до сетевого лага. При крахе мастера можно оперативно назначить «новым мастером» один из слейвов и перенаправить клиентов на него.
Репликация — это в первую очередь инструмент для обеспечения высокой доступности (High Availability) и аварийного восстановления, а НЕ замена резервному копированию!


---

## Задание 2. PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

*Приведите ответ в свободной форме.*

---

## Решение 2

#### Создание резервной копии (бэкап):

```
pg_dump -U username -d database_name -Fc -f backup_file.dump
```
-   `-U username` — имя пользователя БД.
-   `-d database_name` — имя базы данных.
-   `-Fc` — формат custom
-   `-f backup_file.dump` — имя файла, куда сохранится бэкап.

#### Восстановление данных:

```
pg_restore -U username -d database_name backup_file.dump
```
-   Если база уже существует, она очистится и заполнится данными из дампа.
-   Если нужно восстановить в новую базу, сначала нужно создать пустую БД, а потом запустить эту команду.


#### 2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

1.  **Bash-скрипт.** Пишется простой скрипт, в котором прописаны команды `pg_dump`, имя файла с датой (чтобы бэкапы не перезаписывались) и, возможно, команда для удаления старых бэкапов (например, старше 7 дней).
2.  **Планировщик задач (Cron).** В Linux этот скрипт добавляется в `crontab`. Например, можно настроить запуск каждый день, когда нагрузка на базу минимальная.
3.  **Мониторинг.** Нужно ещё мониторить успех выполнения. Можно настроить скрипт так, чтобы он отправлял уведомление (например, в Telegram или на почту), если бэкап не создался или занял слишком мало места.

Также есть специализированные утилиты вроде `pg_cron` внутри самой базы или внешние инструменты вроде `pgBackRest`, которые берут эту автоматизацию на себя.».


---


## Задание 3. MySQL

3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL.

3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

*Приведите ответ в свободной форме.*

---

## Решение 2

#### 3.1. Пример команды инкрементного резервного копирования MySQL
Cтандартная утилита `mysqldump` предназначена в основном для логического полного копирования. Для **инкрементального** резервного копирования рекомендованы инструменты физического бэкапа: **Percona XtraBackup** или **MySQL Enterprise Backup**.

на примере MySQL Enterprise Backup:
```
mysqlbackup --incremental-backup-dir=/path/to/inc_backup backup
```

Или, если использовать популярный в сообществе инструмент **Percona XtraBackup**, команда для создания инкрементальной копии на основе базовой выглядит примерно так:

```
xtrabackup --backup --target-dir=/data/backups/inc1 --incremental-basedir=/data/backups/base
```
Также для восстановления на конкретный момент времени (что близко к идее инкрементальности) используются бинарные логи (binary logs). Но для именно инкрементального бэкапа файлов данных лучше подходит указанные выше утилиты, так как они копируют только измененные блоки, а не дампят SQL-запросы.



#### 3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

- Высокая доступность (High Availability). Если главный сервер (Master) падает, можно быстро переключить нагрузку на Slave-сервер. Обычный бэкап нужно сначала восстанавливать, что занимает время (RTO), а реплика уже работает.

- Минимизация потерь данных (RPO). Репликация работает в реальном времени (или с минимальной задержкой). При аварии мы потеряем данные только за секунды лага, а при бэкапах раз в сутки — все данные за день.

- Масштабирование чтения. На реплику можно скинуть тяжелые SELECT-запросы и отчеты, чтобы не нагружать основную базу. Бэкап для этого не подходит, он лежит на диске.

- Тестирование. На реплике можно безопасно тестировать новые версии ПО или запросы на актуальных данных.

---